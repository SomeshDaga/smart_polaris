<?xml version="1.0"?>
<launch>
  <!-- Visible simulation for manual runs and video (Gazebo GUI + RViz) -->
  <arg name="paused" default="false"/>
  <arg name="use_gui" default="true"/>
  <arg name="use_rviz" default="$(arg use_gui)"/>
  <arg name="use_rqt_reconfigure" default="$(arg use_gui)"/>
  <arg name="robot_name" default="gem"/>
  <!-- Pure pursuit controller if true, otherwise use Stanley controller -->
  <arg name="use_pure_pursuit_controller" default="true" />

  <arg name="wait_for_nav_goal" default="false"/>
  <!-- Waypoints file (runs immediately if wait_for_nav_goal is true) -->
  <arg name="waypoints_file" default="$(find gem_integration_tests)/config/wps.csv"/>

  <!-- Bring up Gazebo (disable default RViz since we use our own RViz config) -->
  <include file="$(find gem_gazebo)/launch/gem_gazebo_rviz.launch">
    <arg name="robot_name" value="$(arg robot_name)"/>
    <arg name="paused" value="$(arg paused)"/>
    <arg name="gui" value="$(arg use_gui)"/>
    <arg name="use_rviz" value="false"/>
  </include>

  <!-- RViz with integration test config (action status + state/task/signals overlay) -->
  <node if="$(arg use_rviz)" name="rviz_integration_test" pkg="rviz" type="rviz"
        args="-d $(find gem_integration_tests)/rviz/gem_integration_tests.rviz"
        output="screen"/>

  <!-- State manager: subscribes to battery_level, estop, gps_accuracy, signal_strength, temperature, task_planner_status -->
  <node name="state_manager" pkg="gem_state_manager" type="state_manager_node" output="screen"/>

  <!-- Mock state signals (battery, gps, signal, estop, temperature) for integration tests; reconfigurable via dynamic_reconfigure -->
  <node name="mock_state_signals_node" pkg="gem_integration_tests" type="mock_state_signals_node.py"
        output="screen"/>

  <!-- RQt Dynamic Reconfigure GUI for tuning mock signals (manual runs) -->
  <node if="$(arg use_rqt_reconfigure)" name="rqt_reconfigure" pkg="rqt_reconfigure" type="rqt_reconfigure" output="screen"/>

  <!-- Pure pursuit controller (if use_pure_pursuit_controller is true) -->
  <node if="$(arg use_pure_pursuit_controller)" name="pure_pursuit_sim" pkg="gem_pure_pursuit_sim_v2" type="pure_pursuit_sim.py"
        output="screen"/>
  <!-- Stanley controller (if use_pure_pursuit_controller is false) -->
  <node unless="$(arg use_pure_pursuit_controller)" name="stanley_sim" pkg="stanley_sim_v2" type="stanley_sim.py"
        output="screen"/>

  <!-- Task planner: serve_waypoints service, publishes task_planner_status, uses navigate_waypoints action -->
  <node name="task_planner" pkg="gem_task_planner" type="task_planner_node.py" output="screen">
    <param name="waypoint_file" value="$(arg waypoints_file)" unless="$(arg wait_for_nav_goal)"/>
  </node>

  <!-- Status overlay for RViz (action status, system_state, task_planner_status, signals, ackermann speed) -->
  <node name="status_overlay_node" pkg="gem_integration_tests" type="status_overlay_node.py"
        output="screen"/>
</launch>
